<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TER</title>
    <link rel="stylesheet" href="https://unpkg.com/mvp.css">
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/persist@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://unpkg.com/alpinejs"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
</head>

<body>
    <main x-data="{ trains: [], alerts: [], start: $persist(87471003), end: $persist(87471037) }"
        x-effect="console.log(start, end, trains)">
        <header>
            <h1>TER</h1>
        </header>
        <form action="#">
            <label>Departure ID:
                <select id="start-search" x-model="start">
                    <option x-bind:value="start" x-text="start" selected="selected"></option>
                </select>
            </label>
            <label>Arrival ID:
                <select id="end-search">
                    <option x-bind:value="end" x-text="end" selected="selected"></option>
                </select>
            </label>
            <button x-on:click="{trains, alerts} = await getTrains(start, end)">Search</button>
        </form>

        <hr>

        <section>
            <table id="resultsTable">
                <thead>
                    <tr>
                        <th>Départ</th>
                        <th></th>
                        <th>Voie</th>
                        <th>Arrivée</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="t in trains" :key="t.departureTime">
                        <tr>
                            <td x-text="t.departureTime"></td>
                            <td x-text="t.departureStation"></td>
                            <td x-text="t.departureTrack"></td>
                            <td x-text="t.arrivalTime"></td>
                            <td x-text="t.arrivalStation"></td>
                        </tr>
                    </template>

                    <template x-if="trains.length === 0">
                        <tr colspan="5">
                            <td>Nothing</td>
                        </tr>
                    </template>

                </tbody>
            </table>
        </section>

        <hr>

        <section>
            <header>
                <h2>Alerts</h2>
            </header>
            <div>
                <ul>
                    <template x-for="m of alerts">
                        <li x-text="m"></li>
                    </template>
                </ul>
                <i x-show="alerts.length === 0">
                    No problemo
                </i>
            </div>
        </section>
    </main>

    <script>
        async function fetchWithRetries(url, options, maxRetries = 3) {
            let attempt = 0;

            while (attempt < maxRetries) {
                try {
                    const response = await fetch(url, options);

                    if (response.ok) {
                        return response; // Successful response, exit the loop
                    }

                } catch (error) {
                    // Error occurred, retry
                }

                attempt++;
            }

            throw new Error(`Max retries exceeded for ${url}`);
        }

        function searchStation(name) {
            const url = 'https://www.ter.sncf.com/api/stop-places-autocompletions/';
            const encodedName = encodeURIComponent(name);
            const fullUrl = `${url}${encodedName}`;

            fetchWithRetries(fullUrl)
                .then((response) => response.json())
                .then((resp) => {
                    resp.forEach((result) => {
                        console.log(`${result.name} (${result.zipCode}) -> id = ${result.id.replace('OCE', '')}`);
                    });
                });
        }

        async function getDepartureTable(idDepart, idArrive) {
            const arrivalsUrl = `https://www.ter.sncf.com/api/next-arrivals?stopPlaceIdUic=OCE${idArrive}&resultLength=20`;
            const response = await fetchWithRetries(arrivalsUrl);
            const data = await response.json();
            const arrivals = data.circulations;

            let lastSituationalMessages = '';

            const now = new Date();
            const midnight = new Date();
            midnight.setHours(23, 59, 59);

            const trains = [];
            const alerts = new Set();

            const queries = [];

            for (const arrival of arrivals) {
                const trainLine = arrival.line;

                if (parseInt(trainLine.origine.id) == idDepart) {
                    const trainDetailsUrl = `https://www.ter.sncf.com/api/circulation-details?number=${trainLine.number}&circulationDate=${encodeURIComponent(arrival.arrivalDate)}&arrivalStopPlaceId=${idArrive}`;
                    queries.push(fetchWithRetries(trainDetailsUrl).then(res => res.json()))

                    for (const situationalMessage of arrival.situationalMessages || []) {
                        if (situationalMessage.categoryName == 'INFORMATION') {
                            continue;
                        }
                        alerts.add(situationalMessage.body)
                    }
                }
            }

            for (const trainDetails of await Promise.all(queries)) {
                const arrivalDate = new Date(trainDetails[trainDetails.length - 1].displayedSchedule);
                const departureDate = new Date(trainDetails[0].displayedSchedule);

                if (departureDate < now) {
                    continue;
                } else if (departureDate > midnight) {
                    break;
                }

                const departureStation = trainDetails[0].stopPlace.name;
                const departureTrack = trainDetails[0].track ? `(Voie ${trainDetails[0].track})` : '-';

                const arrivalStation = trainDetails[trainDetails.length - 1].stopPlace.name;
                const arrivalTrack = trainDetails[trainDetails.length - 1].track ? `(Voie ${trainDetails[trainDetails.length - 1].track})` : '';

                const departureTime = new Intl.DateTimeFormat('fr-FR', { hour: '2-digit', minute: '2-digit', hour12: false }).format(departureDate);
                const arrivalTime = new Intl.DateTimeFormat('fr-FR', { hour: '2-digit', minute: '2-digit', hour12: false }).format(arrivalDate);

                console.log(`${departureTime} ${departureStation} ${departureTrack} -> ${arrivalTime} ${arrivalStation} ${arrivalTrack}`);
                trains.push({ departureTime, departureStation, departureTrack, arrivalTime, arrivalStation, arrivalTrack })
            }

            return {
                trains,
                alerts
            }
        }

        async function getTrains(idDepart, idArrive) {
            try {
                return await getDepartureTable(idDepart, idArrive)
            } catch (error) {
                return {
                    trains: [],
                    alerts: [
                        "Network ERROR"
                    ]
                }
            }
        }

        $(() => {
            $('#start-search').select2({
                ajax: {
                    delay: 250,
                    processResults(data) {
                        return {
                            results: data.map(e => ({
                                id: e.id,
                                text: e.name
                            }))
                        };
                    },
                    url(params) {
                        return 'https://www.ter.sncf.com/api/stop-places-autocompletions/' + encodeURIComponent(params.term);
                    },
                },
            });
        });
    </script>
</body>

</html>